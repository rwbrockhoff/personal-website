---
import { getCollection, getEntry } from 'astro:content';
import Layout from '@layouts/layout.astro';
import GithubIcon from '@images/icons/github.svg';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  const paths = posts.map((post) => {
    const [category, slug] = post.slug.split('/');
    return {
      params: { category, slug },
    };
  });

  return paths;
}

const { category, slug } = Astro.params;
const post = await getEntry('blog', `${category}/${slug}`);

if (!post) throw new Error(`Post not found for slug: ${slug}`);

const { data, render } = post;
const { Content } = await render();
---

<Layout title={data.title}>
  <article>
    <header class="flex-center flex-col readable-width white-text">
      <h1>{data.title}</h1>
      <p>{data.description}</p>

      <p class="post-tags">
        <strong>tags: </strong>
        {data.tags && data.tags.join(', ')}
      </p>

      {
        data.githubLink && (
          <a
            href={data.githubLink}
            class="button button-inverse with-icon"
            target="_blank"
            rel="noopener noreferrer"
          >
            <GithubIcon aria-hidden="true" />
            Github
          </a>
        )
      }
    </header>

    <section class="article-content">
      <a href="/blog" class="blog-button">Back to Blog</a>
      <div class="readable-width">
        <Content />
      </div>
    </section>
  </article>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.querySelector('.blog-button') as HTMLElement;

    if (!button) return;

    button.style.opacity = '0';

    const handleScroll = () => {
      const scrollY = window.scrollY;
      const headerHeight = window.innerHeight * 0.5; // 50vh

      // Show button when scrolled past 50% of header
      if (scrollY > headerHeight * 0.5) button.style.opacity = '1';
      else button.style.opacity = '0';
    };

    window.addEventListener('scroll', handleScroll);
    handleScroll();
  });
</script>

<style>
  article {
    min-height: 100vh;
  }

  a.blog-button {
    position: sticky;
    z-index: 100;
    top: var(--space-xxl);
    left: var(--space-xxl);
    color: var(--primary-color);
    opacity: 0;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
  }

  header {
    width: 100%;
    height: 50vh;
    min-height: fit-content;
    background-color: var(--primary-300);
    background-image: var(--background-grid);
    background-size: var(--space-md) var(--space-md);
    text-align: center;
    padding-top: var(--nav-height);
    box-shadow: var(--box-shadow-light);
  }

  p {
    padding: var(--space-sm) 0;
  }

  .button {
    margin: var(--space-md) 0;
  }

  .post-tags {
    font-size: var(--font-size-xs);
  }

  .article-content {
    margin: var(--space-xxl) auto;
  }

  @media (max-width: 1200px) {
    a.blog-button {
      display: none;
    }
  }
</style>
